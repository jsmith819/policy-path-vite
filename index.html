<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Policy Path (Secured)</title>
    <link rel="stylesheet" href="/src/styles.css" />
  </head>
  <body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
      <div class="login-box">
        <h3>Secure Login</h3>
        <input id="username" placeholder="Username"/>
        <input id="password" type="password" placeholder="Password"/>
        <div class="toggle-password" id="togglePw">Show Password</div>
        <button id="loginBtn">Enter</button>
        <p id="loginError" class="error hidden">Invalid credentials.</p>
      </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="main-app hidden">
      <div class="top-bar">
        <h1>Policy Path</h1>
        <div id="updateBox">Last updated: Never</div>

        <!-- New: Identity button (opens Netlify Identity widget) -->
        <button id="idBtn" title="Account / Sign in">Sign in</button>

        <button id="adminBtn">⚙️</button>
        <div id="adminMenu" class="dropdown">
          <ul>
            <li class="admin-only" id="ctxSettings">Contextual Settings</li>
            <li class="admin-only" id="viewTemplate">View Template</li>
            <li class="admin-only" id="viewUpdates">View Updates</li>
            <li id="trackChanges">Track Changes</li>
            <li class="admin-only" id="demoReset">Demo Reset</li>
            <li class="admin-only" id="toggleSearchBar">Toggle Search Bar</li>
            <li id="logout">Logout</li>
          </ul>
        </div>
      </div>

      <div class="search-container" id="searchContainer">
        <input id="semanticSearch" placeholder="Semantic search..." />
        <button id="searchBtn">Search</button>
      </div>

      <div id="searchResults" class="card hidden">
        <div class="results-header">
          <h3>Search Results</h3>
          <button id="closeResultsBtn" class="icon-btn">×</button>
        </div>
        <div id="resultsContent"></div>
      </div>

      <div id="circle-menu">
        <svg id="policy-wheel" viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>

      <div id="policies-list"></div>

      <div id="docViewer" class="card">
        <div id="docContent">Select a document</div>
        <div id="updateTab" class="update-tab">
          <button id="updatesToggle">Updates ▼</button>
          <div id="updatesContent" class="hidden update-content"></div>
        </div>
      </div>

      <div class="popup" id="adminPopup">
        <h3>Admin: Contextual Settings</h3>
        <input id="orgInput" placeholder="Organisation Name"/>
        <input id="personInput" placeholder="Person"/>
        <input id="serviceInput" placeholder="Service Type"/>
        <button id="saveTokensBtn">Save</button>
        <button id="viewTemplate2">View Template</button>
        <button id="viewUpdates2">View Updates</button>
      </div>

      <div class="popup" id="trackPopup">
        <h3>Change Log</h3>
        <div id="changeLogContent" class="scroll"></div>
        <button id="closeTrack">Close</button>
      </div>
    </div>

    <!-- Netlify Identity CDN widget (must be before your main.ts) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      (function () {
        // guard if the widget isn't loaded for any reason
        if (!window.netlifyIdentity) return;

        // initialize the widget
        netlifyIdentity.init();

        // simple helper to keep the button label tidy
        function setBtnLabel(user) {
          var btn = document.getElementById('idBtn');
          if (!btn) return;
          btn.textContent = user ? 'Account' : 'Sign in';
          btn.title = user ? (user.email || 'Account') : 'Sign in';
        }

        // update label on init/login/logout
        netlifyIdentity.on('init', setBtnLabel);
        netlifyIdentity.on('login', function(user){
          setBtnLabel(user);
          // reload so your app picks up the fresh Identity JWT if you use it
          location.reload();
        });
        netlifyIdentity.on('logout', function(){
          setBtnLabel(null);
          location.reload();
        });

        // clicking the button opens the Identity widget
        document.addEventListener('DOMContentLoaded', function(){
          var btn = document.getElementById('idBtn');
          if (btn) btn.addEventListener('click', function(){
            netlifyIdentity.open(); // opens login/account modal
          });
        });
      })();
    </script>

    <!-- Your app scripts -->
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>

